<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" href="img/ecomap.png" type="image/x-icon">
    <link rel="shortcut icon" href="img/ecomap.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="img/ecomap.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoMap 길찾기</title>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('client_id');
        const clientSecret = urlParams.get('client_secret');
        const odsayAPIKEY = urlParams.get('odsay_apikey')

        if (!clientId || !clientSecret || !odsayAPIKEY) {
            alert('NAVER_CLIENT_ID와 NAVER_CLIENT_SECRET가 필요합니다.');
            throw new Error('NAVER_CLIENT_ID와 NAVER_CLIENT_SECRET가 필요합니다.');
        }

        function loadNaverMapsApi() {
            const script = document.createElement('script');
            script.src = `https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=${clientId}&submodules=geocoder`;
            script.async = true;
            script.onload = initMap;
            document.head.appendChild(script);
        }

        let markers = [];

        function initMap() {
            const mapOptions = {
                center: new naver.maps.LatLng(37.3595704, 127.105399),
                zoom: 10
            };

            const map = new naver.maps.Map('map', mapOptions);

            document.getElementById('submitBtn').addEventListener('click', handleSearch);
            document.getElementById('start').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    handleSearch();
                }
            });
            document.getElementById('destination').addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    handleSearch();
                }
            });

            function handleSearch() {
                const startLocation = document.getElementById('start').value;
                const destinationLocation = document.getElementById('destination').value;

                markers.forEach(marker => marker.setMap(null));
                markers = [];

                getCoordinates(startLocation).then(startCoordinates => {
                    getCoordinates(destinationLocation).then(destCoordinates => {
                        const sx = startCoordinates.lng;
                        const sy = startCoordinates.lat;
                        const ex = destCoordinates.lng;
                        const ey = destCoordinates.lat;

                        const startMarker = addMarker(sy, sx, '출발지', 'img/start.png', 25);
                        markers.push(startMarker);

                        const stopMarker = addMarker(ey, ex, '목적지', 'img/stop.png', 30);
                        markers.push(stopMarker);

                        const bounds = new naver.maps.LatLngBounds();
                        bounds.extend(startMarker.getPosition());
                        bounds.extend(stopMarker.getPosition());
                        map.fitBounds(bounds);

                        searchPubTransPathAJAX(sx, sy, ex, ey);

                        const button = document.getElementById('submitBtn');
                        button.classList.add('clicked');
                        setTimeout(() => {
                            button.classList.remove('clicked');
                        }, 300);
                    });
                }).catch(err => {
                    alert(err);
                });
            }

            function searchPubTransPathAJAX(sx, sy, ex, ey) {
                var xhr = new XMLHttpRequest();
                const url = `https://api.odsay.com/v1/api/searchPubTransPathT?SX=${sx}&SY=${sy}&EX=${ex}&EY=${ey}&apiKey=${odsayAPIKEY}`;
                xhr.open("GET", url, true);
                xhr.send();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var response = JSON.parse(xhr.responseText);
                        callMapObjApiAJAX(response.result.path[0].info.mapObj);
                    }
                }
            }

            function callMapObjApiAJAX(mapObj) {
                var xhr = new XMLHttpRequest();
                const url = `https://api.odsay.com/v1/api/loadLane?mapObject=0:0@${mapObj}&apiKey=${odsayAPIKEY}`;
                xhr.open("GET", url, true);
                xhr.send();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        var resultJsonData = JSON.parse(xhr.responseText);
                        drawNaverPolyLine(resultJsonData);

                        if (resultJsonData.result.boundary) {
                            var boundary = new naver.maps.LatLngBounds(
                                new naver.maps.LatLng(resultJsonData.result.boundary.top, resultJsonData.result.boundary.left),
                                new naver.maps.LatLng(resultJsonData.result.boundary.bottom, resultJsonData.result.boundary.right)
                            );
                            map.panToBounds(boundary);
                        }
                    }
                }
            }

            function drawNaverPolyLine(data) {
                for (var i = 0; i < data.result.lane.length; i++) {
                    for (var j = 0; j < data.result.lane[i].section.length; j++) {
                        var lineArray = [];
                        for (var k = 0; k < data.result.lane[i].section[j].graphPos.length; k++) {
                            lineArray.push(new naver.maps.LatLng(data.result.lane[i].section[j].graphPos[k].y, data.result.lane[i].section[j].graphPos[k].x));
                        }

                        var strokeColor = '#000000';
                        if (data.result.lane[i].type === 1) {
                            strokeColor = '#003499';
                        } else if (data.result.lane[i].type === 2) {
                            strokeColor = '#37b42d';
                        }

                        new naver.maps.Polyline({
                            map: map,
                            path: lineArray,
                            strokeWeight: 3,
                            strokeColor: strokeColor
                        });
                    }
                }
            }

            function addMarker(lat, lng, title, iconUrl, icoSize) {
                return new naver.maps.Marker({
                    position: new naver.maps.LatLng(lat, lng),
                    map: map,
                    title: title,
                    icon: {
                        url: iconUrl || 'img/start.png',
                        scaledSize: new naver.maps.Size(icoSize, icoSize)
                    }
                });
            }

            async function getCoordinates(address) {
                return new Promise((resolve, reject) => {
                    naver.maps.Service.geocode({ query: address }, function(status, response) {
                        if (status !== naver.maps.Service.Status.OK) {
                            return reject(`API 서버 에러! 상태: ${status}`);
                        }
                        const result = response.v2;
                        if (result && result.addresses && result.addresses.length > 0) {
                            const firstAddress = result.addresses[0];
                            resolve({
                                lat: parseFloat(firstAddress.y),
                                lng: parseFloat(firstAddress.x)
                            });
                        } else {
                            reject(`${address} 주소를 찾을 수 없습니다!`);
                        }
                    });
                });
            }
        }

        window.onload = loadNaverMapsApi;
    </script>
    <style>
        /* 스타일은 수정하지 않음 */
    </style>
</head>
<body>

<div id="map"></div>
<div id="controls">
    <label for="start">출발지:</label>
    <input type="text" id="start" placeholder="출발지 입력"><br>
    <label for="destination">목적지:</label>
    <input type="text" id="destination" placeholder="목적지 입력"><br>
    <button id="submitBtn">에코 길찾기</button>
</div>

</body>
</html>